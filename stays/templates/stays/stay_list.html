{% extends "base.html" %}
{% block content %}
  <div class="card" style="margin-bottom:12px; display:flex; justify-content:space-between; align-items:center;">
    <h1 style="margin:0;">Stays</h1>
    <a class="btn" href="{% url 'stays:add' %}">Add Stay</a>
  </div>

  <div class="card" style="padding:0; overflow:auto;">
    <form method="get" style="padding:12px; border-bottom:1px solid var(--border); display:flex; gap:10px; flex-wrap:wrap; align-items:end;">
      <label>
        <div class="muted">Search</div>
        <input class="txt" type="text" name="q" value="{{ selected_q }}" placeholder="Park, city, state, notes" style="min-width:220px;">
      </label>
      <label>
        <div class="muted">State</div>
        <select name="state" multiple size="4" class="txt" style="min-width:100px;">
          {% for st in state_choices %}
            <option value="{{ st }}" {% if st in selected_states %}selected{% endif %}>{{ st }}</option>
          {% endfor %}
        </select>
      </label>
      <label>
        <div class="muted">City</div>
        <select name="city" multiple size="4" class="txt" style="min-width:140px;">
          {% for ct in city_choices %}
            <option value="{{ ct }}" {% if ct in selected_cities %}selected{% endif %}>{{ ct }}</option>
          {% endfor %}
        </select>
      </label>
      <div>
        <div class="muted">Rating</div>
        {% for r in rating_choices %}
          <label style="margin-right:6px;">
            <input type="checkbox" name="rating" value="{{ r }}" {% if r|stringformat:'s' in selected_ratings %}checked{% endif %}> {{ r }}
          </label>
        {% endfor %}
      </div>
      <label>
        <div class="muted">Start</div>
        <input class="txt" type="date" name="start" value="{{ selected_start }}">
      </label>
      <label>
        <div class="muted">End</div>
        <input class="txt" type="date" name="end" value="{{ selected_end }}">
      </label>
      <label>
        <div class="muted">Sort</div>
        <select name="sort" class="txt">
          <option value="date_desc" {% if selected_sort == 'date_desc' %}selected{% endif %}>Newest First</option>
          <option value="date_asc" {% if selected_sort == 'date_asc' %}selected{% endif %}>Oldest First</option>
          <option value="price_desc" {% if selected_sort == 'price_desc' %}selected{% endif %}>Price High → Low</option>
          <option value="price_asc" {% if selected_sort == 'price_asc' %}selected{% endif %}>Price Low → High</option>
          <option value="rating_desc" {% if selected_sort == 'rating_desc' %}selected{% endif %}>Rating High → Low</option>
          <option value="rating_asc" {% if selected_sort == 'rating_asc' %}selected{% endif %}>Rating Low → High</option>
          <option value="park_asc" {% if selected_sort == 'park_asc' %}selected{% endif %}>Park A → Z</option>
        </select>
      </label>
      <div style="display:flex; gap:8px; align-items:center;">
        <button class="btn" type="submit">Apply</button>
        <a class="btn btn-outline" href="{% url 'stays:list' %}">Clear</a>
        <a class="btn btn-outline" href="{% url 'stays:map' %}?{{ map_query }}">Map View</a>
      </div>
    </form>
    <table class="table">
      <thead>
        <tr>
          <th>Photo</th>
          <th>Park</th>
          <th>City</th>
          <th>State</th>
          <th>Check in</th>
          <th>Leave</th>
          <th># Nts</th>
          <th>Rate/nt</th>
          <th>Fees</th>
          <th>Rating <span class="muted" style="font-weight:normal; font-size:0.85em; opacity:0.75;">(edit to change)</span></th>
          <th>Site</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for s in stays %}
          <tr>
            <td>
              {% if s.photo %}
                <a href="{% url 'stays:detail' s.pk %}" title="View stay">
                  <img class="thumb" src="{{ s.photo.url }}" alt="{{ s.park|default:'photo' }}"/>
                </a>
              {% else %}
                &mdash;
              {% endif %}
            </td>
            <td><a href="{% url 'stays:detail' s.pk %}">{{ s.park|default:'&mdash;' }}</a></td>
            <td>{{ s.city|default:'&mdash;' }}</td>
            <td>{{ s.state|default:'&mdash;' }}</td>
            <td>{{ s.check_in|date:"Y-m-d"|default:'&mdash;' }}</td>
            <td>{{ s.leave_date|date:"Y-m-d"|default:'&mdash;' }}</td>
            <td class="num">{{ s.nights|default:0 }}</td>
            <td class="num">{{ s.price_night|default:0|floatformat:2 }}</td>
            <td class="num">{{ s.fees|default:0|floatformat:2 }}</td>
            <td>
              <div aria-label="Rating" title="Edit the stay to change rating">
                {% for i in stars %}
                  <span style="display:inline-block; padding:2px 4px; margin-right:2px; color:{% if s.rating and s.rating >= i %}var(--accent){% else %}#bbb{% endif %};">&#9733;</span>
                {% endfor %}
              </div>
            </td>
            <td>{{ s.site|default:'' }}</td>
            <td><a class="btn btn-outline" href="{% url 'stays:edit' s.pk %}">Edit</a></td>
          </tr>
        {% empty %}
          <tr><td colspan="12" style="padding:16px;">No stays yet</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <script>
    (function(){
      const citiesByState = {{ cities_by_state|safe }};
      const stateSel = document.querySelector('select[name="state"]');
      const citySel  = document.querySelector('select[name="city"]');
      if (!stateSel || !citySel) return;

      function getSelected(el){
        return Array.from(el.options).filter(o => o.selected).map(o => o.value);
      }
      const allCities = Array.from(new Set(Object.values(citiesByState).flat())).sort();

      function rebuildCityOptions(){
        const selectedStates = getSelected(stateSel);
        let allowed = [];
        if (selectedStates.length === 0){
          allowed = allCities.slice();
        } else {
          const set = new Set();
          selectedStates.forEach(st => {
            (citiesByState[st.toUpperCase()] || []).forEach(c => set.add(c));
          });
          allowed = Array.from(set).sort();
        }
        const prevSelected = new Set(getSelected(citySel));
        citySel.innerHTML = '';
        allowed.forEach(ct => {
          const opt = document.createElement('option');
          opt.value = ct; opt.textContent = ct;
          if (prevSelected.has(ct)) opt.selected = true;
          citySel.appendChild(opt);
        });
      }

      stateSel.addEventListener('change', rebuildCityOptions);
      // In case initial HTML not aligned to mapping, sync once on load
      rebuildCityOptions();

      // Quick date presets
      const form = stateSel.closest('form');
      function fmt(d){
        const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,'0'); const x=String(d.getDate()).padStart(2,'0');
        return `${y}-${m}-${x}`;
      }
      function setPresetRange(days){
        const now=new Date();
        const start=new Date(now.getTime()-days*24*3600*1000);
        form.querySelector('input[name="start"]').value = fmt(start);
        form.querySelector('input[name="end"]').value = fmt(now);
        form.submit();
      }
      function setThisYear(){
        const now=new Date();
        const start=new Date(now.getFullYear(),0,1);
        form.querySelector('input[name="start"]').value = fmt(start);
        form.querySelector('input[name="end"]').value = fmt(new Date());
        form.submit();
      }
      const actionsBar = form.querySelector('div[style*="display:flex"][style*="align-items:center"]');
      if (actionsBar){
        const mk = (label, handler)=>{ const b=document.createElement('button'); b.type='button'; b.className='btn btn-outline'; b.textContent=label; b.onclick=handler; return b; };
        const b0 = mk('Last 30 days', ()=>setPresetRange(30));
        const b1 = mk('Last 90 days', ()=>setPresetRange(90));
        const b2 = mk('This Year', setThisYear);
        const b3 = mk('No coords', ()=>{ const cb=form.querySelector('input[name="missing_coords"]'); if (cb) { cb.checked=true; } else { const h=document.createElement('input'); h.type='hidden'; h.name='missing_coords'; h.value='1'; form.appendChild(h);} form.submit(); });
        actionsBar.appendChild(b0); actionsBar.appendChild(b1); actionsBar.appendChild(b2); actionsBar.appendChild(b3);
      }
    })();
  </script>
{% endblock %}
