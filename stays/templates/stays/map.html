{% extends 'base.html' %}
{% block title %}Stays Map{% endblock %}
{% block content %}
<div class="container mx-auto px-4 py-6">
  <h1 class="text-2xl font-semibold mb-4">Stays Map</h1>
  <div id="map" style="height: 70vh; border-radius: 10px; overflow: hidden;"></div>
  <p class="mt-4">
    <a class="btn" href="{% url 'stays:list' %}">Back to list</a>
  </p>
  <form method="post" action="{% url 'stays:map_geocode' %}">
    {% csrf_token %}
    <button class="btn btn-outline" type="submit">Geocode Missing Coordinates</button>
  </form>
</div>

<link rel="stylesheet" href="/static/vendor/leaflet/leaflet.css" onerror="this.href='https://unpkg.com/leaflet@1.9.4/dist/leaflet.css'"/>
<script src="/static/vendor/leaflet/leaflet.js" onerror="this.src='https://unpkg.com/leaflet@1.9.4/dist/leaflet.js'"></script>

<script type="application/json" id="stays-data">{{ stays_json|safe }}</script>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const dataEl = document.getElementById('stays-data');
    const stays = dataEl ? JSON.parse(dataEl.textContent || '[]') : [];

    if (typeof L === 'undefined') {
      const el = document.getElementById('map');
      if (el) el.innerHTML = '<div class="card">Map library failed to load. Check your network or CDN access.</div>';
      return;
    }

    let center = [39.5, -98.35];
    const map = L.map('map').setView(center, stays.length ? 5 : 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const markers = [];
    const cluster = (L.markerClusterGroup ? L.markerClusterGroup() : null);
    stays.forEach(s => {
      if (s.lat == null || s.lng == null) return;
      const viewUrl = `/stays/${s.pk}/`;
      const editUrl = `/stays/${s.pk}/edit/`;
      const html = `
        <div style="min-width:200px">
          <div style="font-weight:700; margin-bottom:4px;">${s.title}</div>
          ${s.subtitle ? `<div style='color:#666; margin-bottom:8px;'>${s.subtitle}</div>` : ''}
          <div style="display:flex; gap:8px;">
            <a class="btn btn-outline" href="${viewUrl}">View</a>
            <a class="btn" href="${editUrl}">Edit</a>
          </div>
        </div>`;
      if (cluster) {
        const icon = L.divIcon({className:'dot-marker', html:'', iconSize:[12,12], iconAnchor:[6,6]});
        const m = L.marker([s.lat, s.lng], { icon }).bindPopup(html);
        cluster.addLayer(m);
        markers.push(m);
      } else {
        const m = L.circleMarker([s.lat, s.lng], { radius: 7, weight: 2, color: '#2563eb', fillColor: '#3b82f6', fillOpacity: 0.9 }).bindPopup(html);
        markers.push(m);
        m.addTo(map);
      }
    });
    if (cluster && markers.length) {
      map.addLayer(cluster);
      map.fitBounds(cluster.getBounds().pad(0.2));
    } else if (markers.length) {
      const group = L.featureGroup(markers);
      map.fitBounds(group.getBounds().pad(0.2));
    }
  });
</script>
{% endblock %}
