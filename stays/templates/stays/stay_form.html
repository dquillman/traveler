{% extends 'base.html' %}
{% block title %}{{ stay|default_if_none:'New' }} Stay{% endblock %}
{% block content %}
<div class="container mx-auto px-4 py-6 max-w-xl">
  <h1 class="text-2xl font-semibold mb-4">{% if stay %}Edit{% else %}Add{% endif %} Stay</h1>
  <form method="post" enctype="multipart/form-data" class="space-y-4">
    {% csrf_token %}
    {{ form.non_field_errors }}
    {% for field in form.visible_fields %}
      <div>
        {{ field.label_tag }} {{ field }}
        {% if field.help_text %}<small class="opacity-70">{{ field.help_text }}</small>{% endif %}
        {{ field.errors }}
        {% if field.name == 'photo' and stay and stay.photo %}
          <div class="mt-2">
            <img src="{{ stay.photo.url }}" alt="{{ stay.park|default:'photo' }}" style="max-width:240px; height:auto; border-radius:8px; border:1px solid var(--border);" />
          </div>
        {% endif %}
      </div>
      {% if field.name == 'leave_date' %}
      <div class="card" style="padding:12px; border:1px solid var(--border); border-radius:8px; background:var(--panel); margin-top:6px;">
        <strong>Nights (auto):</strong>
        <span id="nightsDisplay">0</span>
      </div>
      {% endif %}
    {% endfor %}
    <div class="flex gap-3">
      <button type="submit" class="btn btn-success">Save</button>
      <a href="{% url 'stays:list' %}" class="btn">Cancel</a>
      {% if stay %}
      <button type="submit"
              formaction="{% url 'stays:geocode' stay.pk %}"
              formmethod="post"
              class="btn btn-outline"
              title="Try to fill lat/lng from the address">
        Geocode Now
      </button>
      {% endif %}
      {% if stay %}
      <button type="submit"
              formaction="{% url 'stays:delete' stay.pk %}"
              formmethod="post"
              class="btn btn-danger"
              onclick="return confirm('Are you sure you want to delete this stay?');">
        Delete Stay
      </button>
      {% endif %}
    </div>
  </form>
</div>
{% endblock %}
{% block extra_js %}
<script>
  (function(){
    function parseDate(s){
      if(!s) return null;
      const m = /^([0-9]{4})-([0-9]{2})-([0-9]{2})$/.exec(s.trim());
      if(!m) return null;
      const y = parseInt(m[1],10), mo = parseInt(m[2],10)-1, d = parseInt(m[3],10);
      const dt = new Date(Date.UTC(y, mo, d));
      return isNaN(dt.getTime()) ? null : dt;
    }
    function diffDays(a,b){
      // Match server logic: max((leave - check_in).days, 0)
      const MS = 24*3600*1000;
      const da = parseDate(a), db = parseDate(b);
      if(!da || !db) return 0;
      const n = Math.floor((db - da) / MS);
      return n > 0 ? n : 0;
    }
    function update(){
      const ci = document.querySelector('input[name="check_in"]');
      const ld = document.querySelector('input[name="leave_date"]');
      const out = document.getElementById('nightsDisplay');
      if(!out || !ci || !ld) return;
      out.textContent = diffDays(ci.value, ld.value);
    }
    function ready(fn){ if(document.readyState !== 'loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
    ready(function(){
      const ci = document.querySelector('input[name="check_in"]');
      const ld = document.querySelector('input[name="leave_date"]');
      if(ci) ci.addEventListener('change', update);
      if(ld) ld.addEventListener('change', update);
      update();
    });
  })();
  </script>
{% endblock %}
