<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Stays Map</title>
  <link href="/static/css/theme.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/vendor/leaflet/leaflet.css" onerror="this.href='https://unpkg.com/leaflet@1.9.4/dist/leaflet.css'">
  <style>#map{height: 80vh;}</style>
</head>
<body data-theme="{{ site_appearance.theme|default:'dark' }}">
  <div id="map"></div>
  <form method="post" action="{% url 'stays:map_geocode' %}" style="margin-top:10px;">
    {% csrf_token %}
    <button class="btn btn-outline" type="submit">Geocode Missing Coordinates</button>
  </form>
  <script type="application/json" id="stays-data">{{ stays_json|safe }}</script>
  <script src="/static/vendor/leaflet/leaflet.js" onerror="this.src='https://unpkg.com/leaflet@1.9.4/dist/leaflet.js'"></script>
  <link rel="stylesheet" href="/static/vendor/leaflet.markercluster/MarkerCluster.css">
  <link rel="stylesheet" href="/static/vendor/leaflet.markercluster/MarkerCluster.Default.css">
  <script src="/static/vendor/leaflet.markercluster/leaflet.markercluster.js"></script>
  <style>
    .dot-marker { width:12px; height:12px; background:#3b82f6; border:2px solid #2563eb; border-radius:50%; }
  </style>
  <script>
    const map = L.map('map').setView([39.5, -98.35], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const stays = JSON.parse(document.getElementById('stays-data').textContent || '[]');
    const markers = [];
    const cluster = (L.markerClusterGroup ? L.markerClusterGroup() : null);
    stays.forEach(s => {
      const hasCoords = (typeof s.latitude === 'number' && typeof s.longitude === 'number') ||
                        (typeof s.lat === 'number' && typeof s.lng === 'number');
      if (!hasCoords) return;

      const lat = typeof s.latitude === 'number' ? s.latitude : s.lat;
      const lng = typeof s.longitude === 'number' ? s.longitude : s.lng;
      const name = s.name ?? s.title ?? 'Stay';
      const city = s.city ?? '';
      const state = s.state ?? '';
      const pk = s.pk;
      const viewUrl = pk ? `/stays/${pk}/` : '#';
      const editUrl = pk ? `/stays/${pk}/edit/` : '#';
      const html = `
        <div style="min-width:200px">
          <div style="font-weight:700; margin-bottom:4px;">${name}</div>
          <div style="color:#666; margin-bottom:8px;">${city}${city && state ? ', ' : ''}${state}</div>
          ${pk ? `<div style=\"display:flex; gap:8px;\"><a class=\"btn btn-outline\" href=\"${viewUrl}\">View</a><a class=\"btn\" href=\"${editUrl}\">Edit</a></div>` : ''}
        </div>`;

      if (cluster) {
        const icon = L.divIcon({className:'dot-marker', html:'', iconSize:[12,12], iconAnchor:[6,6]});
        const m = L.marker([lat, lng], { icon })
          .bindPopup(html);
        cluster.addLayer(m);
        markers.push(m);
      } else {
        const m = L.circleMarker([lat, lng], { radius: 7, weight: 2, color: '#2563eb', fillColor: '#3b82f6', fillOpacity: 0.9 })
          .addTo(map)
          .bindPopup(html);
        markers.push(m);
      }
    });

    if (cluster && markers.length) {
      map.addLayer(cluster);
      map.fitBounds(cluster.getBounds().pad(0.2));
    } else if (markers.length) {
      const group = L.featureGroup(markers);
      map.fitBounds(group.getBounds().pad(0.2));
    } else {
      console.warn("No stays with coordinates to display.");
    }
  </script>
</body>
</html>
