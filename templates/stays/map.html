<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Stays Map</title>
  <link rel="stylesheet" href="/static/vendor/leaflet/leaflet.css" onerror="this.href='https://unpkg.com/leaflet@1.9.4/dist/leaflet.css'">
  <style>#map{height: 80vh;}</style>
</head>
<body>
  <div id="map"></div>
  <script type="application/json" id="stays-data">{{ stays_json|safe }}</script>
  <script src="/static/vendor/leaflet/leaflet.js" onerror="this.src='https://unpkg.com/leaflet@1.9.4/dist/leaflet.js'"></script>
  <script>
    const map = L.map('map').setView([39.5, -98.35], 4);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const stays = JSON.parse(document.getElementById('stays-data').textContent || '[]');
    const markers = [];
    stays.forEach(s => {
      const hasCoords = (typeof s.latitude === 'number' && typeof s.longitude === 'number') ||
                        (typeof s.lat === 'number' && typeof s.lng === 'number');
      if (!hasCoords) return;

      const lat = typeof s.latitude === 'number' ? s.latitude : s.lat;
      const lng = typeof s.longitude === 'number' ? s.longitude : s.lng;
      const name = s.name ?? s.title ?? 'Stay';
      const city = s.city ?? '';
      const state = s.state ?? '';
      const pk = s.pk;
      const viewUrl = pk ? `/stays/${pk}/` : '#';
      const editUrl = pk ? `/stays/${pk}/edit/` : '#';
      const html = `
        <div style="min-width:200px">
          <div style="font-weight:700; margin-bottom:4px;">${name}</div>
          <div style="color:#666; margin-bottom:8px;">${city}${city && state ? ', ' : ''}${state}</div>
          ${pk ? `<div style=\"display:flex; gap:8px;\"><a class=\"btn btn-outline\" href=\"${viewUrl}\">View</a><a class=\"btn\" href=\"${editUrl}\">Edit</a></div>` : ''}
        </div>`;

      const m = L.circleMarker([lat, lng], { radius: 7, weight: 2, color: '#2563eb', fillColor: '#3b82f6', fillOpacity: 0.9 })
        .addTo(map)
        .bindPopup(html);
      markers.push(m);
    });

    if (markers.length) {
      const group = L.featureGroup(markers);
      map.fitBounds(group.getBounds().pad(0.2));
    } else {
      console.warn("No stays with coordinates to display.");
    }
  </script>
</body>
</html>
