{% load static %}
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Traveler — Stays</title>
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 16px; }
    .filters { display:flex; gap:12px; align-items:center; margin: 8px 0 16px; }
    label { font-weight: 600; }
    select { padding:6px 8px; }
    table { width:100%; border-collapse: collapse; }
    th, td { padding: 8px 10px; border-bottom: 1px solid #e5e7eb; }
    th { text-align:left; background:#f8fafc; position: sticky; top: 0; }
    .stars { white-space:nowrap; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2ff; }
  </style>
</head>
<body>

<h1>Stays</h1>

<form method="get" class="filters">
  <label>
    State:
    <select name="state" onchange="this.form.submit()">
      <option value="">All</option>
      {% for s in states %}
        <option value="{{ s }}" {% if selected_state|upper == s|upper %}selected{% endif %}>{{ s|upper }}</option>
      {% endfor %}
    </select>
  </label>

  <label>
    Stars:
    <select name="stars" onchange="this.form.submit()">
      <option value="">All</option>
      {% for s in stars_options %}
        <option value="{{ s }}" {% if selected_stars|stringformat:"s" == s|stringformat:"s" %}selected{% endif %}>{{ s }}&#9733;</option>
      {% endfor %}
    </select>
  </label>

  {% if selected_state or selected_stars %}
    <a href="{% url 'stay_list' %}">Reset</a>
  {% endif %}
</form>

<div id="map" style="height:420px;border:1px solid #ddd;border-radius:10px;margin-bottom:16px;"></div>

<table>
  <thead>
    <tr>
      <th>Park</th>
      <th>City</th>
      <th>State</th>
      <th>Check in</th>
      <th>Rating</th>
    </tr>
  </thead>
  <tbody>
  {% for stay in stays %}
    <tr>
      <td>{% firstof stay.park "&mdash;" %}</td>
      <td>{% firstof stay.city "&mdash;" %}</td>
      <td><span class="pill">{% firstof stay.state|upper "&mdash;" %}</span></td>
      <td>{% if stay.check_in %}{{ stay.check_in|date:"Y-m-d" }}{% else %}&mdash;{% endif %}</td>
      <td class="stars">
        {% if stay.rating %}{{ stay.rating }}&#9733;{% else %}&mdash;{% endif %}
      </td>
    </tr>
  {% empty %}
    <tr><td colspan="5">No stays found.</td></tr>
  {% endfor %}
  </tbody>
</table>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
(function(){
  var map = L.map('map');
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18, attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  var q = window.location.search || '';
  {% url 'stays_map_data' as map_url %}
{% if not map_url %}{% url 'stays:stays_map_data' as map_url %}{% endif %}
fetch("{{ map_url|default:'/stays/map-data/' }}" + q)
    .then(function(r){ return r.json(); })
    .then(function(j){
      var stays = j.stays || [];
      if(!stays.length){ map.setView([39.8283,-98.5795],4); return; }
      var group = L.featureGroup();
      stays.forEach(function(s){
        if (typeof s.lat === 'number' && typeof s.lng === 'number') {
          var popup = '<div style="min-width:180px">'
            + '<strong>' + (s.park || 'Stay') + '</strong><br/>'
            + (s.city ? s.city + ', ' : '') + (s.state || '') + '<br/>'
            + (s.check_in ? ('Check in: ' + s.check_in) : '') + '<br/>'
            + (s.rating ? ('Rating: ' + Array(s.rating+1).join('&#9733;')) : '')
            + '</div>';
          L.marker([s.lat, s.lng]).bindPopup(popup).addTo(group);
        }
      });
      if (group.getLayers().length) {
        group.addTo(map);
        map.fitBounds(group.getBounds().pad(0.2));
      } else {
        map.setView([39.8283,-98.5795],4);
      }
    })
    .catch(function(){ map.setView([39.8283,-98.5795],4); });
})();
</script>

</body>
</html>

