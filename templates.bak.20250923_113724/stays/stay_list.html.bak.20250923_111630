{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Traveler â€¢ Stays</title>
  <link rel="icon" href="{% static 'favicon.ico' %}" sizes="any">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-o9N1j7kPvxG8kGHLm0P7E3vhd0JQ8Z8Lx9vZ1C8Q2vY=" crossorigin=""/>
  <style>
    :root { --bg:#0f1220; --card:#161a2b; --ink:#e8ebff; --muted:#9aa4d2; --line:#272b41; --accent:#b9c6ff; }
    *{box-sizing:border-box}
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial; margin:0; background:var(--bg); color:var(--ink); }
    header { padding:14px 18px; background:#101425; color:#fff; display:flex; align-items:center; gap:16px; }
    header .brand { font-weight:700; }
    header nav a { color:var(--accent); text-decoration:none; margin-right:14px; }
    .wrap { max-width:1200px; margin:0 auto; padding:16px; }
    .panel { background:var(--card); border:1px solid var(--line); border-radius:14px; box-shadow:0 8px 24px rgba(0,0,0,.25); }
    #map { width:100%; height:460px; border-radius:14px; background:#0a0d18; }
    table { width:100%; border-collapse:collapse; background:var(--card); border-radius:14px; overflow:hidden; border:1px solid var(--line); }
    th, td { padding:10px 12px; border-bottom:1px solid var(--line); }
    th { text-align:left; color:var(--muted); font-weight:600; background:#12162a; }
    .button { display:inline-block; margin-top:8px; padding:8px 12px; border-radius:10px; border:1px solid var(--line); color:var(--ink); text-decoration:none; background:#1c2040; }
    .muted { color: var(--muted); }
  </style>
</head>
<body>
    <header>
    <div class="brand">Traveler</div>
    <nav>
      <a href="/stays/">Stays</a>
      <a href="/stays/add/">Add</a>
      <a href="/stays/#map">Map</a>
      <a href="/stays/charts/">Charts</a>
      <a href="/stays/import/">Import</a>
      <a href="/stays/export/">Export</a>
      <a href="/appearance/">Appearance</a>
    </nav>
  </header>

  <div class="wrap">
    <div class="panel" style="padding:12px; margin-bottom:16px;">
      <div id="map"></div>
      <p class="muted" style="margin:8px 4px 0;">Pins load from <code>{% url 'stays:stays_map_data' %}</code>.</p>
    </div>

    {% if stays %}
      <table>
        <thead>
          <tr>
            <th>Label</th><th>City</th><th>State</th><th>Check in</th><th>Leave</th>
            <th>Nights</th><th>Rate</th><th>Total</th><th>Fees</th><th>Paid</th><th>Site</th><th></th>
          </tr>
        </thead>
        <tbody>
          {% for s in stays %}
          <tr>
            <td>{% firstof s.park s.site_name s.campground s.location "Stay" %}</td>
            <td>{{ s.city|default:"â€”" }}</td>
            <td>{{ s.state|default:"â€”" }}</td>
            <td>{{ s.check_in|default:"â€”" }}</td>
            <td>{{ s.leave|default:"â€”" }}</td>
            <td>{{ s.nights|default:"â€”" }}</td>
            <td>{% if s.rate_per_night is not None %}${{ s.rate_per_night }}{% else %}â€”{% endif %}</td>
            <td>{% if s.total is not None %}${{ s.total }}{% else %}â€”{% endif %}</td>
            <td>{% if s.fees is not None %}${{ s.fees }}{% else %}â€”{% endif %}</td>
            <td>{{ s.paid|yesno:"Yes,No" }}</td>
            <td>{{ s.site|default:"â€”" }}</td>
            <td><a class="button" href="{% url 'stays:stay_edit' s.id %}">Open / Edit</a></td>
          </tr>
          {% empty %}
          <tr><td colspan="12" style="text-align:center;padding:16px;">No stays yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
      <div style="padding:12px;">
        <a class="button" href="{% url 'stays:add' %}">Add Stay</a>
      </div>
    {% else %}
      <p class="muted">No stays found.</p>
    {% endif %}
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-o4mY9G7yyEJ9vE3F7w2S2U9Q4KQk2r+bQKp1R4C6G2Q=" crossorigin=""></script>
  <script>
  (function(){
    var map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18, attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    var q = window.location.search || '';
    var mapDataUrl = "{% url 'stays:stays_map_data' %}";

    fetch(mapDataUrl + q)
      .then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
      .then(function(j){
        var stays = (j && j.stays) ? j.stays : [];
        var group = L.featureGroup();
        stays.forEach(function(s){
          if (s.latitude != null && s.longitude != null) {
            var html = s.popup_html || '';
            if (s.detail_url) { html += '<br><a href="' + s.detail_url + '">Open / Edit</a>'; }
            var m = L.marker([s.latitude, s.longitude]).bindPopup(html);
            group.addLayer(m);
          }
        });
        if (group.getLayers().length) {
          group.addTo(map);
          map.fitBounds(group.getBounds(), { padding: [20,20] });
        } else {
          map.setView([39.5, -98.35], 4);
        }
      })
      .catch(function(err){
        console.error('Map data error', err);
        map.setView([39.5, -98.35], 4);
      });
  })();
  </script>
</body>
</html>
